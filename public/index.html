<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LaTeX MCQ Input</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="container">
    <!-- User Info Bar -->
    <div class="user-info-bar">
      <div class="user-info">
        <span id="welcomeMessage">Loading...</span>
        <span id="userRole" class="role-badge"></span>
      </div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>
<!-- Add this section in index.html after the user-info-bar div and before the h1 tag -->

<!-- Admin Management Section (Only visible to superusers) -->
<div id="adminSection" class="admin-section" style="display: none;">
  <h2>üîß Admin Management</h2>
  
  <!-- Year Management -->
  <div class="admin-card">
    <h3>üìÖ Year Management</h3>
    <div class="admin-controls">
      <div class="input-group">
        <input type="number" id="newYear" placeholder="Add new year (e.g., 2026)" min="1000" />
        <button onclick="addYear()" class="admin-btn add-btn">‚ûï Add Year</button>
      </div>
      <div class="year-list">
        <h4>Current Years:</h4>
        <div id="yearsList"></div>
      </div>
    </div>
  </div>
  
  <!-- Exam Date Management -->
  <div class="admin-card">
    <h3>üìù Exam Date Management</h3>
    <div class="admin-controls">
      <div class="input-group">
        <select id="dateManagementYear" onchange="loadExamDatesForYear()">
          <option value="">Select Year</option>
        </select>
        <input type="date" id="newExamDate" />
        <button onclick="addExamDate()" class="admin-btn add-btn">‚ûï Add Date</button>
      </div>
      <div class="exam-dates-list">
        <h4>Exam Dates for Selected Year:</h4>
        <div id="examDatesList"></div>
      </div>
    </div>
  </div>
  
  <button onclick="toggleAdminSection()" class="admin-toggle-btn">Hide Admin Panel</button>
</div>

<!-- Admin Toggle Button (Only visible to superusers) -->
<button id="adminToggleBtn" onclick="toggleAdminSection()" class="admin-toggle-btn" style="display: none;">
  Show Admin Panel
</button>
    <h1>Submit MCQ (LaTeX Supported)</h1>

    <form id="mcqForm" method="POST">
      <label>Question Number:</label>
      <input type="text" name="questionNo" id="questionNo" placeholder="e.g., Q1, 1, A-1, etc." required />

      <label>Question (LaTeX):</label>
      <textarea name="question" id="question" rows="3" oninput="renderLatex()" required></textarea>
      <h3>Preview:</h3>
      <div id="preview"></div>
      
      <label>Option 1:</label>
      <input type="text" name="option1" id="option1" required oninput="renderOptionLatex(1)" />
      <div class="option-preview" id="preview-option1"></div>

      <label>Option 2:</label>
      <input type="text" name="option2" id="option2" required oninput="renderOptionLatex(2)" />
      <div class="option-preview" id="preview-option2"></div>

      <label>Option 3:</label>
      <input type="text" name="option3" id="option3" required oninput="renderOptionLatex(3)" />
      <div class="option-preview" id="preview-option3"></div>

      <label>Option 4:</label>
      <input type="text" name="option4" id="option4" required oninput="renderOptionLatex(4)" />
      <div class="option-preview" id="preview-option4"></div>

      <label>Correct Option (1-4):</label>
      <input type="number" name="correctOption" min="1" max="4" required>

      <label for="subject">Subject:</label>
      <select name="subject" id="subject" required onchange="updateTopics()">
        <option value="">-- Select Subject --</option>
        <option value="Maths">Maths</option>
        <option value="Physics">Physics</option>
        <option value="Chemistry">Chemistry</option>
      </select>

      <label for="topic">Topic:</label>
      <select name="topic" id="topic" required>
        <option value="">-- Select Topic --</option>
      </select>

      <label for="difficulty">Difficulty:</label>
      <select name="difficulty" id="difficulty" required>
        <option value="">-- Select Difficulty --</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>

      <!-- PYQ Section -->
      <div class="pyq-section">
        <h3>Previous Year Question (PYQ) Details</h3>
        
        <label for="pyqType">PYQ Type:</label>
        <select name="pyqType" id="pyqType" onchange="togglePyqFields()" required>
          <option value="Not PYQ">Not PYQ</option>
          <option value="JEE MAIN PYQ">JEE MAIN PYQ</option>
        </select>

        <div id="pyqDetails" style="display: none;">
        

          <!-- Year selection -->
          <label for="year">Year:</label>
        <!-- REPLACE WITH EMPTY DROPDOWN -->
<select name="year" id="year" onchange="populateExamDates()">
  <option value="">-- Select Year --</option>
</select>
          <!-- Exam Date selection -->
          <label for="examDate">Exam Date:</label>
          <select name="examDate" id="examDate">
            <option value="">-- Select Exam Date --</option>
          </select>
          <!-- Shift selection -->
          <div id="shiftSection">
            <label>Shift:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="shift" value="Shift 1" />
                Shift 1
              </label>
              <label class="radio-label">
                <input type="radio" name="shift" value="Shift 2" />
                Shift 2
              </label>
            </div>
          </div>

        </div>
      </div>

      <button type="submit">Save</button>
      <button type="button" onclick="clearForm()">Clear Form</button>
      <div id="successMessage"></div>
    </form>
    
    <hr />
    <h2 id="questionsTitle">Your Questions</h2>
    <!-- Replace the existing view questions button and questionList with this complete section -->
<button onclick="loadQuestions()" class="view-questions-btn">üîç View Questions</button>

<!-- Search and Filter Container -->
<div class="search-filter-container" id="searchFilterContainer" style="display: none;">
  <!-- Search Bar -->
  <div class="search-section">
    <input 
      type="text" 
      id="searchInput" 
      placeholder="üîç Search questions, options, topics..." 
      class="search-bar"
      onkeypress="if(event.key === 'Enter') searchQuestions()"
    />
    <button onclick="searchQuestions()" class="search-btn">Search</button>
    <button onclick="clearSearch()" class="clear-search-btn">Clear</button>
  </div>

  <!-- Filter Toggle Button -->
  <button onclick="toggleFilters()" class="filter-toggle-btn">
    <span id="filterToggleIcon">‚ñº</span> Filters
    <span id="activeFilterCount" class="filter-count" style="display: none;">0</span>
  </button>
</div>

<!-- Advanced Filters Section -->
<div id="filterSection" class="filter-section" style="display: none;">
  <div class="filter-grid">
    <!-- Subject Filter -->
    <div class="filter-group">
      <label>Subject:</label>
      <select id="filterSubject" onchange="updateTopicFilter(); applyFilters();">
        <option value="">All Subjects</option>
        <option value="Physics">Physics</option>
        <option value="Chemistry">Chemistry</option>
        <option value="Maths">Maths</option>
      </select>
    </div>

    <!-- Topic Filter -->
    <div class="filter-group">
      <label>Topic:</label>
      <select id="filterTopic" onchange="applyFilters()">
        <option value="">All Topics</option>
      </select>
    </div>

    <!-- Difficulty Filter -->
    <div class="filter-group">
      <label>Difficulty:</label>
      <select id="filterDifficulty" onchange="applyFilters()">
        <option value="">All Difficulties</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>
    </div>

    <!-- PYQ Type Filter -->
    <div class="filter-group">
      <label>PYQ Type:</label>
      <select id="filterPyqType" onchange="applyFilters()">
        <option value="">All Types</option>
        <option value="Not PYQ">Not PYQ</option>
        <option value="JEE MAIN PYQ">JEE MAIN PYQ</option>
      </select>
    </div>

    <!-- Year Filter -->
    <div class="filter-group">
      <label>Year:</label>
      <select id="filterYear" onchange="applyFilters()">
        <option value="">All Years</option>
      </select>
    </div>

    <!-- Sort Options -->
    <div class="filter-group">
      <label>Sort By:</label>
      <select id="sortBy" onchange="applyFilters()">
        <option value="createdAt-desc">Newest First</option>
        <option value="createdAt-asc">Oldest First</option>
        <option value="questionNo-asc">Question No. (A-Z)</option>
        <option value="questionNo-desc">Question No. (Z-A)</option>
        <option value="difficulty-asc">Difficulty (Easy ‚Üí Hard)</option>
        <option value="difficulty-desc">Difficulty (Hard ‚Üí Easy)</option>
      </select>
    </div>

    <!-- Creator Filter (Superuser only) -->
    <div class="filter-group" id="creatorFilterGroup" style="display: none;">
      <label>Created By:</label>
      <select id="filterCreator" onchange="applyFilters()">
        <option value="">All Users</option>
      </select>
    </div>
  </div>

  <!-- Filter Actions -->
  <div class="filter-actions">
    <button onclick="resetFilters()" class="reset-filters-btn">Reset All Filters</button>
  </div>
</div>

<!-- Results Summary -->
<div id="resultsSummary" class="results-summary" style="display: none;">
  Showing <span id="resultsCount">0</span> questions
  <span id="searchSummary"></span>
</div>

<!-- Question List -->
<div id="questionList"></div>
    <div id="questionList"></div>
    <button type="button" onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
  </div>

  <script>
    let currentUser = null;
    let editMode = false;
let editingQuestionId = null;
// Function to edit a question (superuser only)
async function editQuestion(questionId) {
  if (currentUser.role !== 'superuser') {
    alert('Only superusers can edit questions.');
    return;
  }

  try {
    const response = await fetch(`/questions/${questionId}`);
    if (!response.ok) {
      throw new Error('Failed to fetch question details');
    }
    
    const question = await response.json();
    
    // Enable edit mode
    editMode = true;
    editingQuestionId = questionId;
    
    // Update form title and button
    document.querySelector('h1').textContent = 'Edit MCQ (LaTeX Supported)';
    document.querySelector('button[type="submit"]').textContent = 'Update Question';
    
    // Populate form with existing data
    document.getElementById('questionNo').value = question.questionNo;
    document.getElementById('question').value = question.question;
    document.getElementById('option1').value = question.options[0] || '';
    document.getElementById('option2').value = question.options[1] || '';
    document.getElementById('option3').value = question.options[2] || '';
    document.getElementById('option4').value = question.options[3] || '';
    document.querySelector('input[name="correctOption"]').value = question.correctOption + 1;
    document.getElementById('subject').value = question.subject;
    
    // Update topics based on subject
    updateTopics();
    setTimeout(() => {
      document.getElementById('topic').value = question.topic;
    }, 100);
    
    document.getElementById('difficulty').value = question.difficulty;
    document.getElementById('pyqType').value = question.pyqType;
    
    // Handle PYQ details
    if (question.pyqType === 'JEE MAIN PYQ') {
      togglePyqFields();
      document.getElementById('year').value = question.year;
      populateExamDates();
      
      setTimeout(() => {
        if (question.examDate) {
          const examDateFormatted = new Date(question.examDate).toISOString().split('T')[0];
          document.getElementById('examDate').value = examDateFormatted;
        }
        
        if (question.shift) {
          const shiftRadio = document.querySelector(`input[name="shift"][value="${question.shift}"]`);
          if (shiftRadio) {
            shiftRadio.checked = true;
          }
        }
      }, 200);
    }
    
    // Render LaTeX previews
    renderLatex();
    for (let i = 1; i <= 4; i++) {
      renderOptionLatex(i);
    }
    
    // Scroll to form
    document.querySelector('h1').scrollIntoView({ behavior: 'smooth' });
    
  } catch (error) {
    console.error('Error loading question for edit:', error);
    alert('Error loading question for editing.');
  }
}

// Function to cancel edit mode
function cancelEdit() {
  editMode = false;
  editingQuestionId = null;
  document.querySelector('h1').textContent = 'Submit MCQ (LaTeX Supported)';
  document.querySelector('button[type="submit"]').textContent = 'Save';
  clearForm();
}

// Function to delete a question (superuser only)
async function deleteQuestion(questionId) {
  if (currentUser.role !== 'superuser') {
    alert('Only superusers can delete questions.');
    return;
  }

  if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
    return;
  }

  try {
    const response = await fetch(`/questions/${questionId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      alert('Question deleted successfully!');
      loadQuestions(); // Reload the questions list
    } else {
      const errorText = await response.text();
      alert('Failed to delete question: ' + errorText);
    }
  } catch (error) {
    console.error('Error deleting question:', error);
    alert('Error deleting question.');
  }
}



    // Check authentication on page load
   window.onload = async () => {
  try {
    const response = await fetch('/auth/status');
    const data = await response.json();
    
    if (!data.authenticated) {
      window.location.href = '/login.html';
      return;
    }
    
    currentUser = data.user;
    updateUserInterface();
    
    // Always load years for all users
    await loadYears();

  } catch (error) {
    window.location.href = '/login.html';
  }
};

    function updateUserInterface() {
  document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
  const roleElement = document.getElementById('userRole');
  roleElement.textContent = currentUser.role === 'superuser' ? 'Super User' : 'User';
  roleElement.className = `role-badge ${currentUser.role}`;

  const questionsTitle = document.getElementById('questionsTitle');
  questionsTitle.textContent = currentUser.role === 'superuser' ? 'All Questions' : 'Your Questions';

  // Show admin features for superusers
  if (currentUser.role === 'superuser') {
    document.getElementById('adminToggleBtn').style.display = 'block';
    // Load years immediately for superusers so PYQ dropdown is populated
   
  } else {
    // For regular users, still load basic years for the PYQ dropdown
    const defaultYears = [2025, 2024, 2023, 2022, 2021];
    updateMainPyqYearDropdown(defaultYears);
  }
}

    // Populate exam dates based on selected year
   // Update the existing populateExamDates function to use dynamic loading
async function populateExamDates() {
  const year = document.getElementById('year').value;
  const examDateSelect = document.getElementById('examDate');

  // Clear existing options
  examDateSelect.innerHTML = '<option value="">-- Select Exam Date --</option>';

  if (!year) {
    examDateSelect.required = false;
    return;
  }

  try {
    // Always use public endpoint for exam dates
    const response = await fetch(`/public/exam-dates/${year}`);
    if (!response.ok) throw new Error('Failed to load exam dates');

    const examDates = await response.json();
    examDates.forEach(dateObj => {
      const option = document.createElement('option');
      option.value = dateObj.date;
      option.textContent = dateObj.label;
      examDateSelect.appendChild(option);
    });

    examDateSelect.required = true;
  } catch (err) {
    console.error('Error loading exam dates:', err);
    examDateSelect.required = false;
  }
}

    // Toggle PYQ fields based on selection
    function togglePyqFields() {
      const pyqType = document.getElementById('pyqType').value;
      const pyqDetails = document.getElementById('pyqDetails');
      const yearSelect = document.getElementById('year');
      const examDateSelect = document.getElementById('examDate');
      
      if (pyqType === 'Not PYQ') {
        pyqDetails.style.display = 'none';
        yearSelect.required = false;
        examDateSelect.required = false;
        // Clear radio buttons
        document.querySelectorAll('input[name="shift"]').forEach(radio => {
          radio.checked = false;
          radio.required = false;
        });
      } else {
        pyqDetails.style.display = 'block';
        yearSelect.required = true;
        document.querySelectorAll('input[name="shift"]').forEach(radio => {
          radio.required = true;
        });
      }
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    });

    let previewTimeout;

    function renderLatex() {
      clearTimeout(previewTimeout);

      previewTimeout = setTimeout(() => {
        const input = document.getElementById('question').value.trim();
        const preview = document.getElementById('preview');

        if (!input) {
          preview.innerHTML = '<em style="color: #777;">Preview will appear here...</em>';
          return;
        }

        let escaped = input.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        escaped = escaped.replace(/\$\$(.+?)\$\$/gs, (_, match) => `\\[${match.trim()}\\]`);
        escaped = escaped.replace(/(^|[^\\])\$(.+?)\$/g, (_, prefix, match) => `${prefix}\\(${match.trim()}\\)`);

        preview.innerHTML = escaped;

        MathJax.typesetClear([preview]);
        MathJax.typesetPromise([preview]).catch(err => {
          preview.innerHTML = '<span style="color:red;">LaTeX rendering error.</span>';
          console.error('MathJax error:', err);
        });
      }, 300);
    }

    function renderOptionLatex(num) {
      const input = document.getElementById(`option${num}`).value.trim();
      const preview = document.getElementById(`preview-option${num}`);

      if (!input) {
        preview.innerHTML = '<em style="color:#777;">Preview...</em>';
        return;
      }

      let escaped = input.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      escaped = escaped.replace(/\$\$(.+?)\$\$/gs, (_, match) => `\\[${match.trim()}\\]`);
      escaped = escaped.replace(/(^|[^\\])\$(.+?)\$/g, (_, prefix, match) => `${prefix}\\(${match.trim()}\\)`);

      preview.innerHTML = escaped;

      MathJax.typesetClear([preview]);
      MathJax.typesetPromise([preview]).catch(err => {
        preview.innerHTML = '<span style="color:red;">Rendering error</span>';
        console.error('MathJax error:', err);
      });
    }

    function showSuccess() {
      const msg = document.getElementById("successMessage");
      msg.textContent = "‚úÖ Question submitted successfully!";
      msg.style.color = "green";
      setTimeout(() => (msg.textContent = ""), 3000);
      return true;
    }

function clearForm() {
  document.getElementById('mcqForm').reset();
  document.getElementById('preview').innerHTML = '';
  // Clear option previews
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`preview-option${i}`).innerHTML = '';
  }
  // Hide PYQ details
  document.getElementById('pyqDetails').style.display = 'none';
  // Clear exam date options
  document.getElementById('examDate').innerHTML = '<option value="">-- Select Exam Date --</option>';
  
  // Hide cancel button if in edit mode
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (cancelBtn) {
    cancelBtn.style.display = editMode ? 'inline-block' : 'none';
  }
}
    const physicsTopics = ["Physical World and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power", "Rotational Motion", "Gravitation", "Properties of Solids and Liquids", "Thermodynamics", "Kinetic Theory of Gases", "Oscillations and Waves", "Electrostatics", "Current Electricity", "Magnetic Effects of Current and Magnetism", "Electromagnetic Induction and Alternating Currents", "Electromagnetic Waves", "Optics", "Dual Nature of Matter and Radiation", "Atoms and Nuclei", "Electronic Devices", "Communication Systems"];

    const chemistryTopics = ["Some Basic Concepts of Chemistry (Mole Concept)", "Atomic Structure", "Chemical Bonding and Molecular Structure", "Chemical Thermodynamics", "Solutions", "Equilibrium", "Redox Reactions and Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Classification of Elements and Periodicity in Properties", "General Principles and Processes of Isolation of Metals", "Hydrogen", "S-block elements (Alkali and Alkaline earth metals)", "P-block elements", "D and F block elements", "Coordination Compounds", "Environmental Chemistry", "Organic Chemistry ‚Äì Basic Principles and Techniques", "Hydrocarbons", "Haloalkanes and Haloarenes", "Alcohols, Phenols, and Ethers", "Aldehydes, Ketones, and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Polymers", "Biomolecules"];

    const mathsTopics = ["Sets, Relations and Functions", "Complex Numbers and Quadratic Equations", "Matrices and Determinants", "Permutations and Combinations", "Mathematical Induction", "Binomial Theorem", "Sequences and Series", "Limits, Continuity and Differentiability", "Integral Calculus", "Differential Equations", "Coordinate Geometry", "3D Geometry", "Vector Algebra", "Statistics and Probability", "Trigonometry", "Mathematical Reasoning"];

    function updateTopics() {
      const subject = document.getElementById("subject").value;
      const topicSelect = document.getElementById("topic");
      topicSelect.innerHTML = "";

      let topics = [];
      if (subject === "Physics") topics = physicsTopics;
      else if (subject === "Chemistry") topics = chemistryTopics;
      else if (subject === "Maths") topics = mathsTopics;

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "-- Select Topic --";
      topicSelect.appendChild(defaultOption);

      topics.forEach((topic) => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic;
        topicSelect.appendChild(option);
      });
    }

    const form = document.getElementById('mcqForm');

    // Replace the existing form submission handler with this updated version:
form.addEventListener('submit', async function(event) {
  event.preventDefault();

  const formData = new FormData(form);
  const data = {
    questionNo: formData.get('questionNo'),
    question: formData.get('question'),
    options: [
      formData.get('option1'),
      formData.get('option2'),
      formData.get('option3'),
      formData.get('option4')
    ],
    correctOption: formData.get('correctOption'),
    subject: formData.get('subject'),
    topic: formData.get('topic'),
    difficulty: formData.get('difficulty'),
    pyqType: formData.get('pyqType'),
    shift: formData.get('shift') || 'N/A',
    year: formData.get('year') ? parseInt(formData.get('year')) : null,
    examDate: formData.get('examDate') || null
  };

  try {
    let response;
    let successMessage;

    if (editMode && editingQuestionId) {
      // Update existing question
      response = await fetch(`/questions/${editingQuestionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      successMessage = 'Question updated successfully!';
    } else {
      // Create new question
      response = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      successMessage = 'Question added successfully!';
    }

    if (response.ok) {
      alert(successMessage);
      cancelEdit(); // This will clear form and reset edit mode
      loadQuestions(); // Reload questions to show updated data
    } else {
      const errorText = await response.text();
      alert('Failed to save question: ' + errorText);
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
});
    // Update the loadQuestions function in index.html to show creation date/time

// Global variables for search and filter
let allQuestions = [];
let filteredQuestions = [];
let currentSearchTerm = '';
let activeFilters = {
  subject: '',
  topic: '',
  difficulty: '',
  pyqType: '',
  year: '',
  creator: '',
  sortBy: 'createdAt-desc'
};

// New loadQuestions function that integrates with search/filter
async function loadQuestions() {
  try {
    const response = await fetch('/questions');
    
    if (response.status === 401) {
      window.location.href = '/login.html';
      return;
    }
    
    allQuestions = await response.json();
    
    // Show search and filter container
    document.getElementById('searchFilterContainer').style.display = 'flex';
    
    if (allQuestions.length === 0) {
      document.getElementById('questionList').innerHTML = '<p>No questions found.</p>';
      document.getElementById('resultsSummary').style.display = 'none';
      return;
    }

    // Initialize filters on first load
    initializeFilters();
    
    // Display all questions initially
    filteredQuestions = [...allQuestions];
    displayFilteredQuestions();
    updateResultsSummary();
    
  } catch (error) {
    console.error('Error loading questions:', error);
    alert('Error loading questions. Please try again.');
  }
}

// Initialize filters
function initializeFilters() {
  // Show creator filter for superusers
  if (currentUser && currentUser.role === 'superuser') {
    document.getElementById('creatorFilterGroup').style.display = 'block';
    loadCreators();
  }
  
  // Load years for filter
  loadFilterYears();
}

// Load unique creators for filter (superuser only)
function loadCreators() {
  const creators = [...new Set(allQuestions
    .filter(q => q.createdBy && q.createdBy.username)
    .map(q => q.createdBy.username))]
    .sort();
  
  const creatorSelect = document.getElementById('filterCreator');
  creatorSelect.innerHTML = '<option value="">All Users</option>';
  
  creators.forEach(creator => {
    const option = document.createElement('option');
    option.value = creator;
    option.textContent = creator;
    creatorSelect.appendChild(option);
  });
}

// Load years for filter dropdown
function loadFilterYears() {
  const years = [...new Set(allQuestions
    .filter(q => q.year)
    .map(q => q.year))]
    .sort((a, b) => b - a);
  
  const yearSelect = document.getElementById('filterYear');
  yearSelect.innerHTML = '<option value="">All Years</option>';
  
  years.forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  });
}

// Update topic filter based on selected subject
function updateTopicFilter() {
  const selectedSubject = document.getElementById('filterSubject').value;
  const topicSelect = document.getElementById('filterTopic');
  
  topicSelect.innerHTML = '<option value="">All Topics</option>';
  
  if (!selectedSubject) return;
  
  let topics = [];
  if (selectedSubject === 'Physics') topics = physicsTopics;
  else if (selectedSubject === 'Chemistry') topics = chemistryTopics;
  else if (selectedSubject === 'Maths') topics = mathsTopics;
  
  topics.forEach(topic => {
    const option = document.createElement('option');
    option.value = topic;
    option.textContent = topic;
    topicSelect.appendChild(option);
  });
}

// Toggle filter section visibility
function toggleFilters() {
  const filterSection = document.getElementById('filterSection');
  const toggleIcon = document.getElementById('filterToggleIcon');
  
  if (filterSection.style.display === 'none') {
    filterSection.style.display = 'block';
    toggleIcon.textContent = '‚ñ≤';
  } else {
    filterSection.style.display = 'none';
    toggleIcon.textContent = '‚ñº';
  }
}

// Search functionality
function searchQuestions() {
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  currentSearchTerm = searchTerm;
  applyFilters();
}

// Clear search
function clearSearch() {
  document.getElementById('searchInput').value = '';
  currentSearchTerm = '';
  applyFilters();
}

// Apply all filters and search
function applyFilters() {
  // Get filter values
  activeFilters = {
    subject: document.getElementById('filterSubject').value,
    topic: document.getElementById('filterTopic').value,
    difficulty: document.getElementById('filterDifficulty').value,
    pyqType: document.getElementById('filterPyqType').value,
    year: document.getElementById('filterYear').value,
    creator: document.getElementById('filterCreator')?.value || '',
    sortBy: document.getElementById('sortBy').value
  };

  // Start with all questions
  filteredQuestions = [...allQuestions];

  // Apply filters
  if (activeFilters.subject) {
    filteredQuestions = filteredQuestions.filter(q => q.subject === activeFilters.subject);
  }

  if (activeFilters.topic) {
    filteredQuestions = filteredQuestions.filter(q => q.topic === activeFilters.topic);
  }

  if (activeFilters.difficulty) {
    filteredQuestions = filteredQuestions.filter(q => q.difficulty === activeFilters.difficulty);
  }

  if (activeFilters.pyqType) {
    filteredQuestions = filteredQuestions.filter(q => q.pyqType === activeFilters.pyqType);
  }

  if (activeFilters.year) {
    filteredQuestions = filteredQuestions.filter(q => q.year === parseInt(activeFilters.year));
  }

  if (activeFilters.creator && currentUser.role === 'superuser') {
    filteredQuestions = filteredQuestions.filter(q => 
      q.createdBy && q.createdBy.username === activeFilters.creator
    );
  }

  // Apply search
  if (currentSearchTerm) {
    filteredQuestions = filteredQuestions.filter(q => {
      const searchableText = [
        q.questionNo || '',
        q.question || '',
        ...(q.options || []),
        q.subject || '',
        q.topic || '',
        q.difficulty || '',
        q.pyqType || ''
      ].join(' ').toLowerCase();
      
      return searchableText.includes(currentSearchTerm);
    });
  }

  // Apply sorting
  const [sortField, sortOrder] = activeFilters.sortBy.split('-');
  filteredQuestions.sort((a, b) => {
    let compareValue = 0;
    
    switch(sortField) {
      case 'createdAt':
        compareValue = new Date(a.createdAt) - new Date(b.createdAt);
        break;
      case 'questionNo':
        compareValue = (a.questionNo || '').localeCompare(b.questionNo || '');
        break;
      case 'difficulty':
        const difficultyOrder = { easy: 1, medium: 2, hard: 3 };
        compareValue = (difficultyOrder[a.difficulty] || 0) - (difficultyOrder[b.difficulty] || 0);
        break;
    }
    
    return sortOrder === 'desc' ? -compareValue : compareValue;
  });

  // Update UI
  displayFilteredQuestions();
  updateFilterCount();
  updateResultsSummary();
}

// Display filtered questions
function displayFilteredQuestions() {
  const list = document.getElementById('questionList');
  list.innerHTML = '';

  if (filteredQuestions.length === 0) {
    list.innerHTML = '<p>No questions match your search/filters.</p>';
    return;
  }

  filteredQuestions.forEach((q, i) => {
    const div = document.createElement('div');
    div.className = 'question-card';
    
    let creatorInfo = '';
    if (currentUser.role === 'superuser' && q.createdBy) {
      const createdDate = new Date(q.createdAt);
      const formattedDateTime = createdDate.toLocaleString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        hour12: true
      });

      creatorInfo = `
        <div class="creator-info">
          <div><strong>Created by:</strong> ${q.createdBy.username || 'Unknown'}</div>
          <div><strong>Created on:</strong> ${formattedDateTime}</div>
        </div>
      `;
    }

 // In the displayFilteredQuestions() function, update the pyqInfo section:

let pyqInfo = '';
if (q.pyqType && q.pyqType !== 'Not PYQ') {
  pyqInfo = `<div class="pyq-info">
    <strong>PYQ:</strong> ${q.pyqType}
    ${q.examDate ? ` - ${new Date(q.examDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}` : ''}
    ${q.shift && q.shift !== 'N/A' ? ` - ${q.shift}` : ''}
  </div>`;
}
    let actionButtons = '';
    if (currentUser.role === 'superuser') {
      actionButtons = `
        <div class="action-buttons">
          <button onclick="editQuestion('${q._id}')" class="edit-btn">‚úèÔ∏è Edit</button>
          <button onclick="deleteQuestion('${q._id}')" class="delete-btn">üóëÔ∏è Delete</button>
        </div>
      `;
    }
    
    // Highlight search terms
    let questionHtml = highlightSearchTerm(q.question);
    let optionsHtml = q.options.map((opt, idx) => {
      let optionHtml = highlightSearchTerm(opt);
      return `<li${idx === q.correctOption ? ' style="font-weight:bold;color:green;"' : ''}>${String.fromCharCode(65 + idx)}. ${optionHtml}</li>`;
    }).join('');
    
    div.innerHTML = `
      <div class="question-header">
        <strong>Question No: ${highlightSearchTerm(q.questionNo)}</strong>
      </div>
      <strong>Q${i + 1}:</strong> ${questionHtml}<br/>
      <ul>${optionsHtml}</ul>
      <div class="question-meta">
        <em>Subject:</em> ${q.subject}, <em>Topic:</em> ${q.topic}, <em>Difficulty:</em> ${q.difficulty}
      </div>
      ${pyqInfo}
      ${creatorInfo}
      ${actionButtons}
      <hr/>
    `;
    list.appendChild(div);
  });

  // Re-render MathJax
  if (typeof MathJax !== 'undefined') {
    MathJax.typesetPromise([list]).catch(err => console.error('MathJax error:', err));
  }
}

// Highlight search terms in text
function highlightSearchTerm(text) {
  if (!currentSearchTerm || !text) return text;
  
  // Escape special regex characters
  const escapedTerm = currentSearchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${escapedTerm})`, 'gi');
  return text.replace(regex, '<span class="search-highlight">$1</span>');
}

// Update active filter count
function updateFilterCount() {
  let count = 0;
  
  if (activeFilters.subject) count++;
  if (activeFilters.topic) count++;
  if (activeFilters.difficulty) count++;
  if (activeFilters.pyqType) count++;
  if (activeFilters.year) count++;
  if (activeFilters.creator) count++;
  
  const filterCountElement = document.getElementById('activeFilterCount');
  if (count > 0) {
    filterCountElement.textContent = count;
    filterCountElement.style.display = 'inline-block';
  } else {
    filterCountElement.style.display = 'none';
  }
}

// Update results summary
function updateResultsSummary() {
  const summaryDiv = document.getElementById('resultsSummary');
  const countSpan = document.getElementById('resultsCount');
  const searchSummarySpan = document.getElementById('searchSummary');
  
  if (!summaryDiv || !countSpan) return;
  
  summaryDiv.style.display = 'block';
  countSpan.textContent = filteredQuestions.length;
  
  if (currentSearchTerm && searchSummarySpan) {
    searchSummarySpan.textContent = ` matching "${currentSearchTerm}"`;
  } else if (searchSummarySpan) {
    searchSummarySpan.textContent = '';
  }
}

// Reset all filters
function resetFilters() {
  // Reset form values
  document.getElementById('filterSubject').value = '';
  document.getElementById('filterTopic').value = '';
  document.getElementById('filterDifficulty').value = '';
  document.getElementById('filterPyqType').value = '';
  document.getElementById('filterYear').value = '';
  document.getElementById('sortBy').value = 'createdAt-desc';
  
  const creatorFilter = document.getElementById('filterCreator');
  if (creatorFilter) {
    creatorFilter.value = '';
  }
  
  // Reset search
  document.getElementById('searchInput').value = '';
  currentSearchTerm = '';
  
  // Reset topic dropdown
  document.getElementById('filterTopic').innerHTML = '<option value="">All Topics</option>';
  
  // Apply filters (which will now show all questions)
  applyFilters();
}  
// Add these functions to your index.html script section

// Function to load years from backend
// Function to load years from backend
async function loadYears() {
  try {
    console.log('Loading years...');
    
    // Use appropriate endpoint based on user role
    const endpoint = currentUser && currentUser.role === 'superuser' 
      ? '/admin/years' 
      : '/public/years';
    
    const response = await fetch(endpoint);
    console.log('Response status:', response.status);
    
    if (response.ok) {
      const years = await response.json();
      console.log('Years received from backend:', years);
      
      // Only update admin dropdowns for superusers
      if (currentUser && currentUser.role === 'superuser') {
        updateYearDropdowns(years);
        displayCurrentYears(years);
      }
      
      // Always update main PYQ dropdown
      updateMainPyqYearDropdown(years);
    } else {
      console.error('Failed to load years:', response.status);
      const defaultYears = [2025, 2024, 2023, 2022, 2021];
      updateMainPyqYearDropdown(defaultYears);
    }
  } catch (error) {
    console.error('Error loading years:', error);
    const defaultYears = [2025, 2024, 2023, 2022, 2021];
    updateMainPyqYearDropdown(defaultYears);
  }
}
// Function to update the main PYQ year dropdown
// Function to update the main PYQ year dropdown
function updateMainPyqYearDropdown(yearsData) {
  const mainYearSelect = document.getElementById('year');
  
  // Handle both array and object with years property
  let years = Array.isArray(yearsData) ? yearsData : (yearsData.years || []);
  
  console.log('Updating main PYQ dropdown with years:', years);
  
  // Store currently selected value
  const currentValue = mainYearSelect.value;
  
  // Clear existing options
  mainYearSelect.innerHTML = '<option value="">-- Select Year --</option>';
  
  // Add years to main dropdown (sort in descending order for better UX)
  years.sort((a, b) => b - a).forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    mainYearSelect.appendChild(option);
  });
  
  // Restore previously selected value if it still exists
  if (currentValue && years.includes(parseInt(currentValue))) {
    mainYearSelect.value = currentValue;
  }
}
// Function to update year dropdowns (admin panel only)
function updateYearDropdowns(yearsData) {
  const dateManagementYear = document.getElementById('dateManagementYear');
  
  // Handle both array and object with years property
  let years = Array.isArray(yearsData) ? yearsData : (yearsData.years || []);
  
  // Clear existing options
  dateManagementYear.innerHTML = '<option value="">Select Year</option>';
  
  // Add years to admin dropdown
  years.sort((a, b) => b - a).forEach(year => {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    dateManagementYear.appendChild(option);
  });
}

function displayCurrentYears(yearsData) {
  const yearsList = document.getElementById('yearsList');
  yearsList.innerHTML = '';
  
  // Handle both array and object with years property
  let years = Array.isArray(yearsData) ? yearsData : (yearsData.years || []);
  
  console.log('Displaying current years:', years);
  
  years.forEach(year => {
    const yearItem = document.createElement('div');
    yearItem.className = 'year-item';
    yearItem.innerHTML = `
      <span>${year}</span>
      <button onclick="removeYear(${year})" class="admin-btn delete-btn">‚ùå Remove</button>
    `;
    yearsList.appendChild(yearItem);
  });
}
// Function to add a new year
// Function to add a new year
async function addYear() {
  const newYearInput = document.getElementById('newYear');
  const year = parseInt(newYearInput.value);
  
   if (!year || year < 1000) {
    alert('Please enter a valid 4-digit year');
    return;
  }
  
  try {
    const response = await fetch('/admin/years', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year })
    });
    
    if (response.ok) {
      alert('Year added successfully!');
      newYearInput.value = '';
      
      // Add a small delay before reloading to ensure backend has saved the data
      setTimeout(() => {
        loadYears();
      }, 500);
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error adding year:', error);
    alert('Error adding year');
  }
}

// Function to remove a year
// Function to remove a year
async function removeYear(year) {
  if (!confirm(`Are you sure you want to remove year ${year}?`)) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/years/${year}`, {
      method: 'DELETE'
    });
    
    if (response.ok) {
      alert('Year removed successfully!');
      loadYears(); // This will now update both admin and main dropdowns
      
      // Clear exam date dropdown if the removed year was selected
      const mainYearSelect = document.getElementById('year');
      if (parseInt(mainYearSelect.value) === year) {
        document.getElementById('examDate').innerHTML = '<option value="">-- Select Exam Date --</option>';
      }
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error removing year:', error);
    alert('Error removing year');
  }
}
// Function to load exam dates for selected year
async function loadExamDatesForYear() {
  const year = document.getElementById('dateManagementYear').value;
  if (!year) {
    document.getElementById('examDatesList').innerHTML = '';
    return;
  }
  
  try {
    // Admin panel should use the public endpoint too, or create a separate admin endpoint
    const response = await fetch(`/public/exam-dates/${year}`);
    if (response.ok) {
      const examDates = await response.json();
      displayExamDates(examDates, year);
    }
  } catch (error) {
    console.error('Error loading exam dates:', error);
  }
}

// Function to display exam dates
function displayExamDates(examDates, year) {
  const examDatesList = document.getElementById('examDatesList');
  examDatesList.innerHTML = '';
  
  examDates.forEach(dateObj => {
    const dateItem = document.createElement('div');
    dateItem.className = 'exam-date-item';
    dateItem.innerHTML = `
      <span>${dateObj.label}</span>
      <button onclick="removeExamDate('${year}', '${dateObj.date}')" class="admin-btn delete-btn">‚ùå Remove</button>
    `;
    examDatesList.appendChild(dateItem);
  });
}

// Function to add exam date
async function addExamDate() {
  const year = document.getElementById('dateManagementYear').value;
  const date = document.getElementById('newExamDate').value;
  
  if (!year || !date) {
    alert('Please select a year and date');
    return;
  }
  
  try {
    const response = await fetch('/admin/exam-dates', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year: parseInt(year), date })
    });
    
    if (response.ok) {
      alert('Exam date added successfully!');
      document.getElementById('newExamDate').value = '';
      loadExamDatesForYear(); // Reload exam dates
     populateExamDates(); // Update the main form's exam dates
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error adding exam date:', error);
    alert('Error adding exam date');
  }
}

// Function to remove exam date
async function removeExamDate(year, date) {
  if (!confirm('Are you sure you want to remove this exam date?')) {
    return;
  }
  
  try {
    const response = await fetch('/admin/exam-dates', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ year: parseInt(year), date })
    });
    
    if (response.ok) {
      alert('Exam date removed successfully!');
      loadExamDatesForYear(); // Reload exam dates
      populateExamDates(); // Update the main form's exam dates
    } else {
      const error = await response.json();
      alert('Error: ' + error.error);
    }
  } catch (error) {
    console.error('Error removing exam date:', error);
    alert('Error removing exam date');
  }
}

// Function to load available exam dates for the main form

// Function to show/hide admin section
function toggleAdminSection() {
  const adminSection = document.getElementById('adminSection');
  const toggleBtn = document.getElementById('adminToggleBtn');
  
  if (adminSection.style.display === 'none') {
    adminSection.style.display = 'block';
    toggleBtn.style.display = 'none';
    // Reload years when opening admin panel to ensure fresh data
    if (currentUser.role === 'superuser') {
      loadYears();
    }
  } else {
    adminSection.style.display = 'none';
    toggleBtn.style.display = 'block';
  }
}

// Update the existing populateExamDates function

// Update the existing updateUserInterface function to include admin panel setup
function updateUserInterface() {
  document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
  
  const roleElement = document.getElementById('userRole');
  roleElement.textContent = currentUser.role === 'superuser' ? 'Super User' : 'User';
  roleElement.className = `role-badge ${currentUser.role}`;
  
  const questionsTitle = document.getElementById('questionsTitle');
  questionsTitle.textContent = currentUser.role === 'superuser' ? 'All Questions' : 'Your Questions';
  
  // Show admin features for superusers
  if (currentUser.role === 'superuser') {
    document.getElementById('adminToggleBtn').style.display = 'block';
  }
}

 
  </script>
</body>
</html>