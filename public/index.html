<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>LaTeX MCQ Input</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <div class="container">
    <!-- User Info Bar -->
    <div class="user-info-bar">
      <div class="user-info">
        <span id="welcomeMessage">Loading...</span>
        <span id="userRole" class="role-badge"></span>
      </div>
      <button id="logoutBtn" class="logout-btn">Logout</button>
    </div>

    <h1>Submit MCQ (LaTeX Supported)</h1>

    <form id="mcqForm" method="POST">
      <label>Question Number:</label>
      <input type="text" name="questionNo" id="questionNo" placeholder="e.g., Q1, 1, A-1, etc." required />

      <label>Question (LaTeX):</label>
      <textarea name="question" id="question" rows="3" oninput="renderLatex()" required></textarea>
      <h3>Preview:</h3>
      <div id="preview"></div>
      
      <label>Option 1:</label>
      <input type="text" name="option1" id="option1" required oninput="renderOptionLatex(1)" />
      <div class="option-preview" id="preview-option1"></div>

      <label>Option 2:</label>
      <input type="text" name="option2" id="option2" required oninput="renderOptionLatex(2)" />
      <div class="option-preview" id="preview-option2"></div>

      <label>Option 3:</label>
      <input type="text" name="option3" id="option3" required oninput="renderOptionLatex(3)" />
      <div class="option-preview" id="preview-option3"></div>

      <label>Option 4:</label>
      <input type="text" name="option4" id="option4" required oninput="renderOptionLatex(4)" />
      <div class="option-preview" id="preview-option4"></div>

      <label>Correct Option (1-4):</label>
      <input type="number" name="correctOption" min="1" max="4" required>

      <label for="subject">Subject:</label>
      <select name="subject" id="subject" required onchange="updateTopics()">
        <option value="">-- Select Subject --</option>
        <option value="Maths">Maths</option>
        <option value="Physics">Physics</option>
        <option value="Chemistry">Chemistry</option>
      </select>

      <label for="topic">Topic:</label>
      <select name="topic" id="topic" required>
        <option value="">-- Select Topic --</option>
      </select>

      <label for="difficulty">Difficulty:</label>
      <select name="difficulty" id="difficulty" required>
        <option value="">-- Select Difficulty --</option>
        <option value="easy">Easy</option>
        <option value="medium">Medium</option>
        <option value="hard">Hard</option>
      </select>

      <!-- PYQ Section -->
      <div class="pyq-section">
        <h3>Previous Year Question (PYQ) Details</h3>
        
        <label for="pyqType">PYQ Type:</label>
        <select name="pyqType" id="pyqType" onchange="togglePyqFields()" required>
          <option value="Not PYQ">Not PYQ</option>
          <option value="JEE MAIN PYQ">JEE MAIN PYQ</option>
        </select>

        <div id="pyqDetails" style="display: none;">
        

          <!-- Year selection -->
          <label for="year">Year:</label>
          <select name="year" id="year" onchange="populateExamDates()">
            <option value="">-- Select Year --</option>
            <option value="2025">2025</option>
            <option value="2024">2024</option>
            <option value="2023">2023</option>
            <option value="2022">2022</option>
            <option value="2021">2021</option>
          </select>

          <!-- Exam Date selection -->
          <label for="examDate">Exam Date:</label>
          <select name="examDate" id="examDate">
            <option value="">-- Select Exam Date --</option>
          </select>
          <!-- Shift selection -->
          <div id="shiftSection">
            <label>Shift:</label>
            <div class="radio-group">
              <label class="radio-label">
                <input type="radio" name="shift" value="Shift 1" />
                Shift 1
              </label>
              <label class="radio-label">
                <input type="radio" name="shift" value="Shift 2" />
                Shift 2
              </label>
            </div>
          </div>

        </div>
      </div>

      <button type="submit">Save</button>
      <button type="button" onclick="clearForm()">Clear Form</button>
      <div id="successMessage"></div>
    </form>
    
    <hr />
    <h2 id="questionsTitle">Your Questions</h2>
    <button onclick="loadQuestions()">üîç View Questions</button>
    <div id="questionList"></div>
    <button type="button" onclick="cancelEdit()" id="cancelEditBtn" style="display: none;">Cancel Edit</button>
  </div>

  <script>
    let currentUser = null;
    let editMode = false;
let editingQuestionId = null;
// Function to edit a question (superuser only)
async function editQuestion(questionId) {
  if (currentUser.role !== 'superuser') {
    alert('Only superusers can edit questions.');
    return;
  }

  try {
    const response = await fetch(`/questions/${questionId}`);
    if (!response.ok) {
      throw new Error('Failed to fetch question details');
    }
    
    const question = await response.json();
    
    // Enable edit mode
    editMode = true;
    editingQuestionId = questionId;
    
    // Update form title and button
    document.querySelector('h1').textContent = 'Edit MCQ (LaTeX Supported)';
    document.querySelector('button[type="submit"]').textContent = 'Update Question';
    
    // Populate form with existing data
    document.getElementById('questionNo').value = question.questionNo;
    document.getElementById('question').value = question.question;
    document.getElementById('option1').value = question.options[0] || '';
    document.getElementById('option2').value = question.options[1] || '';
    document.getElementById('option3').value = question.options[2] || '';
    document.getElementById('option4').value = question.options[3] || '';
    document.querySelector('input[name="correctOption"]').value = question.correctOption + 1;
    document.getElementById('subject').value = question.subject;
    
    // Update topics based on subject
    updateTopics();
    setTimeout(() => {
      document.getElementById('topic').value = question.topic;
    }, 100);
    
    document.getElementById('difficulty').value = question.difficulty;
    document.getElementById('pyqType').value = question.pyqType;
    
    // Handle PYQ details
    if (question.pyqType === 'JEE MAIN PYQ') {
      togglePyqFields();
      document.getElementById('year').value = question.year;
      populateExamDates();
      
      setTimeout(() => {
        if (question.examDate) {
          const examDateFormatted = new Date(question.examDate).toISOString().split('T')[0];
          document.getElementById('examDate').value = examDateFormatted;
        }
        
        if (question.shift) {
          const shiftRadio = document.querySelector(`input[name="shift"][value="${question.shift}"]`);
          if (shiftRadio) {
            shiftRadio.checked = true;
          }
        }
      }, 200);
    }
    
    // Render LaTeX previews
    renderLatex();
    for (let i = 1; i <= 4; i++) {
      renderOptionLatex(i);
    }
    
    // Scroll to form
    document.querySelector('h1').scrollIntoView({ behavior: 'smooth' });
    
  } catch (error) {
    console.error('Error loading question for edit:', error);
    alert('Error loading question for editing.');
  }
}

// Function to cancel edit mode
function cancelEdit() {
  editMode = false;
  editingQuestionId = null;
  document.querySelector('h1').textContent = 'Submit MCQ (LaTeX Supported)';
  document.querySelector('button[type="submit"]').textContent = 'Save';
  clearForm();
}

// Function to delete a question (superuser only)
async function deleteQuestion(questionId) {
  if (currentUser.role !== 'superuser') {
    alert('Only superusers can delete questions.');
    return;
  }

  if (!confirm('Are you sure you want to delete this question? This action cannot be undone.')) {
    return;
  }

  try {
    const response = await fetch(`/questions/${questionId}`, {
      method: 'DELETE'
    });

    if (response.ok) {
      alert('Question deleted successfully!');
      loadQuestions(); // Reload the questions list
    } else {
      const errorText = await response.text();
      alert('Failed to delete question: ' + errorText);
    }
  } catch (error) {
    console.error('Error deleting question:', error);
    alert('Error deleting question.');
  }
}

    // Exam dates for different years (sample data - you can modify these)
    const examDates = {
      2025: [
        { date: '2025-01-22', label: 'January 22, 2025' },
        { date: '2025-01-24', label: 'January 24, 2025' },
        { date: '2025-01-29', label: 'January 29, 2025' },
        { date: '2025-01-31', label: 'January 31, 2025' },
        { date: '2025-04-01', label: 'April 1, 2025' },
        { date: '2025-04-04', label: 'April 4, 2025' },
        { date: '2025-04-08', label: 'April 8, 2025' },
        { date: '2025-04-12', label: 'April 12, 2025' }
      ],
      2024: [
        { date: '2024-01-24', label: 'January 24, 2024' },
        { date: '2024-01-27', label: 'January 27, 2024' },
        { date: '2024-01-29', label: 'January 29, 2024' },
        { date: '2024-01-31', label: 'January 31, 2024' },
        { date: '2024-02-01', label: 'February 1, 2024' },
        { date: '2024-04-04', label: 'April 4, 2024' },
        { date: '2024-04-06', label: 'April 6, 2024' },
        { date: '2024-04-08', label: 'April 8, 2024' },
        { date: '2024-04-09', label: 'April 9, 2024' },
        { date: '2024-04-15', label: 'April 15, 2024' }
      ],
      2023: [
        { date: '2023-01-24', label: 'January 24, 2023' },
        { date: '2023-01-25', label: 'January 25, 2023' },
        { date: '2023-01-29', label: 'January 29, 2023' },
        { date: '2023-01-30', label: 'January 30, 2023' },
        { date: '2023-01-31', label: 'January 31, 2023' },
        { date: '2023-02-01', label: 'February 1, 2023' },
        { date: '2023-04-06', label: 'April 6, 2023' },
        { date: '2023-04-08', label: 'April 8, 2023' },
        { date: '2023-04-10', label: 'April 10, 2023' },
        { date: '2023-04-11', label: 'April 11, 2023' },
        { date: '2023-04-13', label: 'April 13, 2023' },
        { date: '2023-04-15', label: 'April 15, 2023' }
      ],
      2022: [
        { date: '2022-06-23', label: 'June 23, 2022' },
        { date: '2022-06-24', label: 'June 24, 2022' },
        { date: '2022-06-25', label: 'June 25, 2022' },
        { date: '2022-06-26', label: 'June 26, 2022' },
        { date: '2022-06-27', label: 'June 27, 2022' },
        { date: '2022-06-28', label: 'June 28, 2022' },
        { date: '2022-06-29', label: 'June 29, 2022' },
        { date: '2022-07-21', label: 'July 21, 2022' },
        { date: '2022-07-25', label: 'July 25, 2022' },
        { date: '2022-07-28', label: 'July 28, 2022' },
        { date: '2022-07-30', label: 'July 30, 2022' }
      ],
      2021: [
        { date: '2021-02-23', label: 'February 23, 2021' },
        { date: '2021-02-24', label: 'February 24, 2021' },
        { date: '2021-02-25', label: 'February 25, 2021' },
        { date: '2021-02-26', label: 'February 26, 2021' },
        { date: '2021-03-16', label: 'March 16, 2021' },
        { date: '2021-03-17', label: 'March 17, 2021' },
        { date: '2021-03-18', label: 'March 18, 2021' },
        { date: '2021-07-20', label: 'July 20, 2021' },
        { date: '2021-07-22', label: 'July 22, 2021' },
        { date: '2021-07-25', label: 'July 25, 2021' },
        { date: '2021-07-27', label: 'July 27, 2021' },
        { date: '2021-08-26', label: 'August 26, 2021' },
        { date: '2021-08-31', label: 'August 31, 2021' },
        { date: '2021-09-02', label: 'September 2, 2021' }
      ]
    };

    // Check authentication on page load
    window.onload = async () => {
      try {
        const response = await fetch('/auth/status');
        const data = await response.json();
        
        if (!data.authenticated) {
          window.location.href = '/login.html';
          return;
        }
        
        currentUser = data.user;
        updateUserInterface();
      } catch (error) {
        window.location.href = '/login.html';
      }
    };

    function updateUserInterface() {
      document.getElementById('welcomeMessage').textContent = `Welcome, ${currentUser.username}!`;
      
      const roleElement = document.getElementById('userRole');
      roleElement.textContent = currentUser.role === 'superuser' ? 'Super User' : 'User';
      roleElement.className = `role-badge ${currentUser.role}`;
      
      const questionsTitle = document.getElementById('questionsTitle');
      questionsTitle.textContent = currentUser.role === 'superuser' ? 'All Questions' : 'Your Questions';
    }

    // Populate exam dates based on selected year
    function populateExamDates() {
      const year = document.getElementById('year').value;
      const examDateSelect = document.getElementById('examDate');
      
      // Clear existing options
      examDateSelect.innerHTML = '<option value="">-- Select Exam Date --</option>';
      
      if (year && examDates[year]) {
        examDates[year].forEach(dateObj => {
          const option = document.createElement('option');
          option.value = dateObj.date;
          option.textContent = dateObj.label;
          examDateSelect.appendChild(option);
        });
        examDateSelect.required = true;
      } else {
        examDateSelect.required = false;
      }
    }

    // Toggle PYQ fields based on selection
    function togglePyqFields() {
      const pyqType = document.getElementById('pyqType').value;
      const pyqDetails = document.getElementById('pyqDetails');
      const yearSelect = document.getElementById('year');
      const examDateSelect = document.getElementById('examDate');
      
      if (pyqType === 'Not PYQ') {
        pyqDetails.style.display = 'none';
        yearSelect.required = false;
        examDateSelect.required = false;
        // Clear radio buttons
        document.querySelectorAll('input[name="shift"]').forEach(radio => {
          radio.checked = false;
          radio.required = false;
        });
      } else {
        pyqDetails.style.display = 'block';
        yearSelect.required = true;
        document.querySelectorAll('input[name="shift"]').forEach(radio => {
          radio.required = true;
        });
      }
    }

    // Logout functionality
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/logout', { method: 'POST' });
        window.location.href = '/login.html';
      } catch (error) {
        console.error('Logout failed:', error);
      }
    });

    let previewTimeout;

    function renderLatex() {
      clearTimeout(previewTimeout);

      previewTimeout = setTimeout(() => {
        const input = document.getElementById('question').value.trim();
        const preview = document.getElementById('preview');

        if (!input) {
          preview.innerHTML = '<em style="color: #777;">Preview will appear here...</em>';
          return;
        }

        let escaped = input.replace(/</g, '&lt;').replace(/>/g, '&gt;');
        escaped = escaped.replace(/\$\$(.+?)\$\$/gs, (_, match) => `\\[${match.trim()}\\]`);
        escaped = escaped.replace(/(^|[^\\])\$(.+?)\$/g, (_, prefix, match) => `${prefix}\\(${match.trim()}\\)`);

        preview.innerHTML = escaped;

        MathJax.typesetClear([preview]);
        MathJax.typesetPromise([preview]).catch(err => {
          preview.innerHTML = '<span style="color:red;">LaTeX rendering error.</span>';
          console.error('MathJax error:', err);
        });
      }, 300);
    }

    function renderOptionLatex(num) {
      const input = document.getElementById(`option${num}`).value.trim();
      const preview = document.getElementById(`preview-option${num}`);

      if (!input) {
        preview.innerHTML = '<em style="color:#777;">Preview...</em>';
        return;
      }

      let escaped = input.replace(/</g, '&lt;').replace(/>/g, '&gt;');
      escaped = escaped.replace(/\$\$(.+?)\$\$/gs, (_, match) => `\\[${match.trim()}\\]`);
      escaped = escaped.replace(/(^|[^\\])\$(.+?)\$/g, (_, prefix, match) => `${prefix}\\(${match.trim()}\\)`);

      preview.innerHTML = escaped;

      MathJax.typesetClear([preview]);
      MathJax.typesetPromise([preview]).catch(err => {
        preview.innerHTML = '<span style="color:red;">Rendering error</span>';
        console.error('MathJax error:', err);
      });
    }

    function showSuccess() {
      const msg = document.getElementById("successMessage");
      msg.textContent = "‚úÖ Question submitted successfully!";
      msg.style.color = "green";
      setTimeout(() => (msg.textContent = ""), 3000);
      return true;
    }

function clearForm() {
  document.getElementById('mcqForm').reset();
  document.getElementById('preview').innerHTML = '';
  // Clear option previews
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`preview-option${i}`).innerHTML = '';
  }
  // Hide PYQ details
  document.getElementById('pyqDetails').style.display = 'none';
  // Clear exam date options
  document.getElementById('examDate').innerHTML = '<option value="">-- Select Exam Date --</option>';
  
  // Hide cancel button if in edit mode
  const cancelBtn = document.getElementById('cancelEditBtn');
  if (cancelBtn) {
    cancelBtn.style.display = editMode ? 'inline-block' : 'none';
  }
}
    const physicsTopics = ["Physical World and Measurement", "Kinematics", "Laws of Motion", "Work, Energy and Power", "Rotational Motion", "Gravitation", "Properties of Solids and Liquids", "Thermodynamics", "Kinetic Theory of Gases", "Oscillations and Waves", "Electrostatics", "Current Electricity", "Magnetic Effects of Current and Magnetism", "Electromagnetic Induction and Alternating Currents", "Electromagnetic Waves", "Optics", "Dual Nature of Matter and Radiation", "Atoms and Nuclei", "Electronic Devices", "Communication Systems"];

    const chemistryTopics = ["Some Basic Concepts of Chemistry (Mole Concept)", "Atomic Structure", "Chemical Bonding and Molecular Structure", "Chemical Thermodynamics", "Solutions", "Equilibrium", "Redox Reactions and Electrochemistry", "Chemical Kinetics", "Surface Chemistry", "Classification of Elements and Periodicity in Properties", "General Principles and Processes of Isolation of Metals", "Hydrogen", "S-block elements (Alkali and Alkaline earth metals)", "P-block elements", "D and F block elements", "Coordination Compounds", "Environmental Chemistry", "Organic Chemistry ‚Äì Basic Principles and Techniques", "Hydrocarbons", "Haloalkanes and Haloarenes", "Alcohols, Phenols, and Ethers", "Aldehydes, Ketones, and Carboxylic Acids", "Organic Compounds Containing Nitrogen", "Polymers", "Biomolecules"];

    const mathsTopics = ["Sets, Relations and Functions", "Complex Numbers and Quadratic Equations", "Matrices and Determinants", "Permutations and Combinations", "Mathematical Induction", "Binomial Theorem", "Sequences and Series", "Limits, Continuity and Differentiability", "Integral Calculus", "Differential Equations", "Coordinate Geometry", "3D Geometry", "Vector Algebra", "Statistics and Probability", "Trigonometry", "Mathematical Reasoning"];

    function updateTopics() {
      const subject = document.getElementById("subject").value;
      const topicSelect = document.getElementById("topic");
      topicSelect.innerHTML = "";

      let topics = [];
      if (subject === "Physics") topics = physicsTopics;
      else if (subject === "Chemistry") topics = chemistryTopics;
      else if (subject === "Maths") topics = mathsTopics;

      const defaultOption = document.createElement("option");
      defaultOption.value = "";
      defaultOption.textContent = "-- Select Topic --";
      topicSelect.appendChild(defaultOption);

      topics.forEach((topic) => {
        const option = document.createElement("option");
        option.value = topic;
        option.textContent = topic;
        topicSelect.appendChild(option);
      });
    }

    const form = document.getElementById('mcqForm');

    // Replace the existing form submission handler with this updated version:
form.addEventListener('submit', async function(event) {
  event.preventDefault();

  const formData = new FormData(form);
  const data = {
    questionNo: formData.get('questionNo'),
    question: formData.get('question'),
    options: [
      formData.get('option1'),
      formData.get('option2'),
      formData.get('option3'),
      formData.get('option4')
    ],
    correctOption: formData.get('correctOption'),
    subject: formData.get('subject'),
    topic: formData.get('topic'),
    difficulty: formData.get('difficulty'),
    pyqType: formData.get('pyqType'),
    shift: formData.get('shift') || 'N/A',
    year: formData.get('year') ? parseInt(formData.get('year')) : null,
    examDate: formData.get('examDate') || null
  };

  try {
    let response;
    let successMessage;

    if (editMode && editingQuestionId) {
      // Update existing question
      response = await fetch(`/questions/${editingQuestionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      successMessage = 'Question updated successfully!';
    } else {
      // Create new question
      response = await fetch('/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data),
      });
      successMessage = 'Question added successfully!';
    }

    if (response.ok) {
      alert(successMessage);
      cancelEdit(); // This will clear form and reset edit mode
      loadQuestions(); // Reload questions to show updated data
    } else {
      const errorText = await response.text();
      alert('Failed to save question: ' + errorText);
    }
  } catch (error) {
    alert('Error: ' + error.message);
  }
});
    async function loadQuestions() {
  try {
    const response = await fetch('/questions');
    
    if (response.status === 401) {
      window.location.href = '/login.html';
      return;
    }
    
    const questions = await response.json();
    const list = document.getElementById('questionList');
    list.innerHTML = '';

    if (questions.length === 0) {
      list.innerHTML = '<p>No questions found.</p>';
      return;
    }

    questions.forEach((q, i) => {
      const div = document.createElement('div');
      div.className = 'question-card';
      
      let creatorInfo = '';
      if (currentUser.role === 'superuser' && q.createdBy) {
        creatorInfo = `<div class="creator-info">Created by: <strong>${q.createdBy.username || 'Unknown'}</strong></div>`;
      }

      let pyqInfo = '';
      if (q.pyqType && q.pyqType !== 'Not PYQ') {
        pyqInfo = `<div class="pyq-info">
          <strong>PYQ:</strong> ${q.pyqType}
          ${q.shift && q.shift !== 'N/A' ? ` - ${q.shift}` : ''}
          ${q.year ? ` (${q.year})` : ''}
          ${q.examDate ? ` - ${new Date(q.examDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}` : ''}
        </div>`;
      }

      // Add edit/delete buttons for superuser
      let actionButtons = '';
      if (currentUser.role === 'superuser') {
        actionButtons = `
          <div class="action-buttons">
            <button onclick="editQuestion('${q._id}')" class="edit-btn">‚úèÔ∏è Edit</button>
            <button onclick="deleteQuestion('${q._id}')" class="delete-btn">üóëÔ∏è Delete</button>
          </div>
        `;
      }
      
      div.innerHTML = `
        <div class="question-header">
          <strong>Question No: ${q.questionNo}</strong>
        </div>
        <strong>Q${i + 1}:</strong> ${q.question}<br/>
        <ul>
          ${q.options.map((opt, idx) => `
            <li${idx === q.correctOption ? ' style="font-weight:bold;color:green;"' : ''}>${String.fromCharCode(65 + idx)}. ${opt}</li>`).join('')}
        </ul>
        <div class="question-meta">
          <em>Subject:</em> ${q.subject}, <em>Topic:</em> ${q.topic}, <em>Difficulty:</em> ${q.difficulty}
        </div>
        ${pyqInfo}
        ${creatorInfo}
        ${actionButtons}
        <hr/>
      `;
      list.appendChild(div);
    });

    MathJax.typesetPromise([list]);
  } catch (error) {
    console.error('Error loading questions:', error);
    alert('Error loading questions. Please try again.');
  }
}
  </script>
</body>
</html>